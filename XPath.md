# Preface
Creating Barotrauma XML mods is pretty easy since it is a matter of copy/paste and edit. Maintaining Barotrauma XML mods over multiple releases is difficult since you have to manually determine any changes to the vanilla XML and then modify your modded XML.

The easiest solution to this issue is to allow some method of modifying the game entities without having to copy them. There have been multiple attempts to do this including one by myself. I believe that the main reason they all have failed is that they required significant changes to the Barotrauma code.

I created this XPath implementation with the following objectives;
1. Do not modify ANY Fake Fish code
2. Don't reinvent the wheel
3. Be flexible without being needlessly complicated


# XPath
XPath files types allow patching of one or more source XML documents is a much more maintainable way then standard Barotrauma XML modding. This is done via [XML Path Language](https://developer.mozilla.org/en-US/docs/Web/XPath) or XPath.

This implementation of XPath patching has been heavily influenced by the implementation use by Rimworld, but has been adapted to more closely fit the feel of Barotrauma XML modding.

### Basics
XPath files have to be registered in the filelist.xml like any other mod files. They have their own special types based on what type of entities they are going to patch.
```
<?xml version="1.0" encoding="utf-8"?>
<contentpackage name="Simple Pockets" modversion="1.0" corepackage="False" gameversion="1.5.8.0">
  <XPathItems file="%ModDir%/SimplePocketsXPath.xml" />
</contentpackage>
```
The currently supported types are;
* XPathAfflictions
* XPathItems
* XPathTalents
* XPathCharacters

When a mod containing supported XPath file types the XPath files will automatically patch the source files to an output file. The output file will then be loaded by Barotrauma as if it was a pre-existing XML file that was provided with the mod download.

### Naming Convention
It is advised to name your XPath patcher files with XPath (case-insensitive) in the name so that the name of generated XML file will match up accordingly.
* MyThingXPath.xml -> MyThing.xml
* MyThing-XPath.xml -> MyThing.xml
* XPath_MyThing.xml -> MyThing.xml

### Patcher Structure

```
<?xml version="1.0" encoding="utf-8"?>
<ItemPatcher debug="true">
    <Sources>
        <Source contentfile="Content/Items/idcard.xml"/>
    </Sources>

    <Items>
        <Item identifier="idcard" override="True">
            <Add>
                <XPath>.</XPath>
                <Value>
                    <Deconstruct time="5" />
                </Value>
            </Add>
        </Item>
    </Items>
</ItemPatcher>
```
The above script will render the following XML which is then loaded by Barotrauma.
```
<?xml version="1.0" encoding="UTF-8"?>
<!--Generated by XPath Patcher DeconstructableJunkXPath.xml-->
<Items>
  <Override>
    <!--Source: Content/Items/idcard.xml XPath: /Items/Item[@identifier='idcard']|/Items/Override/Item[@identifier='idcard']-->
    <Item name="" identifier="idcard" category="Equipment" Tags="smallitem,identitycard" cargocontaineridentifier="metalcrate">
      <PreferredContainer primary="crewcab" />
      <Price baseprice="10">
        <Price storeidentifier="merchantoutpost" minavailable="4" />
        <Price storeidentifier="merchantcity" minavailable="6" />
      </Price>
      <InventoryIcon texture="Content/Items/InventoryIconAtlas.png" sourcerect="192,64,64,64" origin="0.5,0.5" />
      <Sprite texture="idcard.png" depth="0.5" sourcerect="0,0,16,16" />
      <Body width="16" height="12" density="10.05" />
      <IdCard slots="Card,Any" msg="ItemMsgPickUpSelect" />
      <Deconstruct time="5" />
    </Item>
  </Override>
</Items>
```

#### Patcher Type
The root tag defines the patcher type. This tag should match the type defined in the filelist.xml.
Currently supported options include `AfflictionPatcher`, `ItemPatcher`, `TalentPatcher` and `CharacterPatcher`.

The optional `debug` tag can be set to `true` to increase logging.

#### Sources
A patcher should include one or more Source tags. This tells the patcher where to look to find the XML to patch. Sources will be processed in order. The first instance of a given element will be used.

The optional `required="false"` tag can be used to allow the patcher to continue if a source file is not found.

Currently, the only supported source type is a contentFile. I have plans to add additional source types in the future to allow mods to patch other mods in an easier way.

#### Elements
The elements block allows defining one or more elements that will be read from the Sources and patched. The Elements block should match the Root Patcher type. In this case `Items` with `Item` children.

There are currently several ways to select elements. The attribute tag options will automatically generate the XPath query for you.
1. Find by identifier `identifier="element-id"`
2. Find by tags `tags="element-tag"`
3. Find by SpeciesName tag `speciesname="speciesname-name"`
4. Find by custom query `<XPath>//Items/Item[@nameidentifier='bananapeel']</XPath>`

The optional Override attribute will wrap the rendered item in an `<Override>` tag.

Each Element block supports an optional Predicates block that can be used to filter the Element matches further. The Predicate also supports a `not="true"` attribute that inverts the match.            
```
<Predicates>
    <Predicate>//Wearable[contains(@slots,'InnerClothes')]</Predicate>
</Predicates>
```

#### Operations
The Operations list is adapted from the operations provided by [Rimworld](https://rimworldwiki.com/wiki/Modding_Tutorials/PatchOperations#PatchOperation_Types).

The basic XML operations support an XML block in the `<Value>...</Value>` and require a `<XPath>...</XPath>` tag. Setting a XPath value of '.' will reference the current Element.
Basic XML Operations:
* Add
* Insert
* Remove
* Replace

The Attribute operations can take a string in the `<Value>...</Value>` and also require an `attribute="attribute-name"` attribute to indicate the target attribute name.
XML Attribute Operations
* AddAttribute
* InsertAttribute
* RemoveAttribute
* ReplaceAttribute

```
<ReplaceAttribute attribute="multiplyvalue">
    <XPath>.//AbilityGroupEffect[@abilityeffecttype="OnGainMissionExperience"]/Abilities/CharacterAbilityModifyValue</XPath>
    <Value>1.5</Value>
</ReplaceAttribute>
```

Each Operation also supports the same Predicates block documented above.